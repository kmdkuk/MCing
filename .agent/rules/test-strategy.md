---
trigger: model_decision
description: テストコード実装・変更時に適用。テスト観点表（等価分割・境界値）の作成、Given/When/Then形式、カバレッジ目標のルール
---

# テスト戦略ルール

これらのルールは、テストコードを実装または変更する際に必ず従うべきテストプロセスを定義する。以下のすべてのステップを満たさない限り、テストタスクは完了したとはみなされない。

---

## 1. テスト観点表（等価分割・境界値）

1. いかなるテスト作業を開始する前にも、まず Markdown 形式の「テスト観点表（test perspectives table）」を提示しなければならない。
2. 表には少なくとも次の列を含めること: `Case ID`, `Input / Precondition`, `Perspective (Equivalence / Boundary)`, `Expected Result`, `Notes`。
3. 行は正常系・異常系・境界値のケースを網羅すること。境界値については、最低でも `0 / 最小値 / 最大値 / ±1 / 空 / NULL` を含める。
   境界値候補（0 / 最小値 / 最大値 / ±1 / 空 / NULL）のうち仕様上意味を持たないものは、`Notes` に対象外とする理由を記載したうえで省略してよい。
4. 後から観点漏れに気づいた場合は、セルフレビュー後に表を更新し、必要なケースを追加すること。
5. なお、既存テストの軽微な修正（メッセージ調整や期待値の微修正など）であり、新しい分岐や制約が追加されない場合は、テスト観点表の新規作成・更新は任意とする。

### テンプレート例

| Case ID | Input / Precondition | Perspective (Equivalence / Boundary) | Expected Result                               | Notes |
|--------|----------------------|---------------------------------------|----------------------------------------------|-------|
| TC-N-01 | Valid input A        | Equivalence – normal                 | Processing succeeds and returns expected value | -     |
| TC-A-01 | NULL                 | Boundary – NULL                      | Validation error (required field)            | -     |
| ...     | ...                  | ...                                   | ...                                          | ...   |

---

## 2. テストコード実装ポリシー

1. 上記の表に記載したケースを **すべて** 自動化テストとして実装する。
2. **正常系と同数以上の失敗系**（バリデーションエラー、例外、外部依存失敗など）を必ず含める。
3. 以下の観点をテストで網羅する:
   - 正常系（主要シナリオ）
   - 異常系（バリデーションエラー、例外パス）
   - 境界値（0, 最小, 最大, ±1, 空, NULL）
   - 不正な型・形式の入力
   - 外部依存の失敗（API / DB / メッセージング等が該当する場合）
   - 例外種別およびエラーメッセージ
4. さらに、分岐網羅率 100% を目標にし、必要に応じて追加ケースを自ら設計する。
   分岐網羅 100% は目標値とし、達成が合理的でない場合は、少なくともビジネスインパクトの高い分岐および主要なエラー経路を網羅すること。
   未カバーとなる分岐がある場合は、その理由と影響を `Notes` や PR 本文に明示する。

---

## 3. Given / When / Then コメント

各テストケースには必ず以下のコメントフォーマットを付与する。

```text
// Given: 前提条件
// When:  実行する操作
// Then:  期待する結果/検証
```

コメントはテストコード直上またはステップ内に記述し、読み手がシナリオを追えるように保つこと。

---

## 4. 例外・エラー検証

1. 例外が発生するケースでは、例外の**型**と**メッセージ**を明示的に検証する。
2. バリデーション系の異常系では、エラーコードやフィールド情報があれば併せて確認する。
3. 外部依存の失敗を模す場合は、スタブ/モックを利用して期待する例外・リトライ・フォールバックが呼ばれるかを確認する。

---

## 5. 実行コマンドとカバレッジ

1. テスト実装の最後に、**実行コマンド**と**カバレッジ取得方法**をドキュメントやPR本文の末尾に必ず記載する。
   - 例: `npm run test`, `pnpm vitest run --coverage`, `pytest --cov=...`
2. ブランチカバレッジ・ステートメントカバレッジを確認し、分岐網羅 100% を目標とする（達成が合理的でない場合は、ビジネスインパクトの高い分岐および主要なエラー経路を優先的に網羅すること）。
3. カバレッジレポートの確認結果（スクリーンショットや要約）を可能な範囲で添付する。

---

## 6. 運用上の注意

1. 本ルールに適合しないテストの差分はレビューで差し戻す。
2. 外部依存がない場合でも、失敗系は**モックを活用して擬似的に失敗させる**こと。
3. テスト対象の仕様に新しい分岐や制約が追加された場合、テスト観点表とテストコードを同時に更新する。
4. 自動化が困難なケースがある場合は、理由と代替手段を明記した上でレビューアと合意形成を行う。
   代替手段には少なくとも、対象機能とリスク、手動検証手順、期待される結果、およびログやスクリーンショットの保存方法を含めること。
5. 原則として、本番コードに意味のある変更（仕様追加・バグ修正・挙動に影響し得るリファクタ）を含むPRには、対応する自動テストの追加または更新を必ず含めること。
6. テストの追加・更新が合理的に困難な場合は、その理由と代替となる検証手順（手動テスト手順など）をPR本文に明記し、レビュアと合意を取ること。
7. 挙動変更を意図しないリファクタであっても、変更箇所が既存テストで十分にカバーされているかを確認し、不足している場合はテストを追加すること。

---

このルールを遵守し、欠落観点がないか常に自己チェックしたうえでテストを設計・実装すること。